{"version":3,"file":"scripts/updateYtbPlayerCurrentQuality.js","mappings":"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","sources":["webpack://vpnn-extension/./scripts/updateYtbPlayerCurrentQuality.ts"],"sourcesContent":["/**\n * Этот файл компилируется в js стандарными инструментами ts\n * поэтому в нем не должно быть импортов или экспортов\n *\n * Типы указанные в этом файле должны дублировать типы\n * указанные в файлe src/content/scripts/youtubeRestrictionQuality/ytbRestrictionQuality.ts\n */\n\nconst YTB_LOCAL_STORAGE_QUALITY_KEY = 'yt-player-quality';\nconst YTB_SCRIPT_SOURCE = 'ytb-quality-script';\nconst YTB_PLAYER_ID = 'movie_player';\nconst DEFAULT_QUALITY = 'hd1080' as YTbQualityLevel;\nconst ENFORCING_QUALITY_CHECK_INTERVAL = 60000; //1 minute\n\nenum YTbPlayerActions {\n  'set-quality' = 'SET_QUALITY',\n  'stop-restrict-quality' = 'STOP_RESTRICT_QUALITY',\n}\n\nconst chosenQualityMap: Record<string, YTbQualityLevel> = {\n  '1080': 'hd1080',\n  '720': 'hd720',\n  '480': 'large',\n  '360': 'medium',\n  '240': 'small',\n  '144': 'tiny',\n};\n\ntype YTbQualityLevel =\n  | 'highres'\n  | 'hd2880'\n  | 'hd2160'\n  | 'hd1440'\n  | 'hd1080'\n  | 'hd720'\n  | 'large'\n  | 'medium'\n  | 'small'\n  | 'tiny'\n  | 'auto';\n\nconst qualityOrder: Array<YTbQualityLevel> = [\n  'hd1080',\n  'hd720',\n  'large',\n  'medium',\n  'small',\n  'tiny',\n];\n\nconsole.warn('[Ytb Enforcer] Quality order', qualityOrder);\n\ninterface YTbPlayer {\n  // Качество\n  getAvailableQualityLevels(): YTbQualityLevel[];\n  setPlaybackQuality(quality: YTbQualityLevel): void;\n  setPlaybackQualityRange?(quality: YTbQualityLevel): void;\n  getPlaybackQuality(): YTbQualityLevel;\n\n  addEventListener?(event: string, handler: (...args: any[]) => void): void;\n\n  // Прочее (по необходимости)\n  [key: string]: any;\n}\n\ntype GlobalStateType = {\n  /** Текущее выбранное качество */\n  chosenQuality: YTbQualityLevel | null;\n  /** ID интервала */\n  enforceIntervalId: number | null;\n  /** Ссылка на плеер */\n  playerRef: YTbPlayer | null;\n};\n\nconst globalState: GlobalStateType = {\n  chosenQuality: null,\n  enforceIntervalId: null,\n  playerRef: null,\n};\n\nfunction getPlayer(): YTbPlayer | null {\n  const player = document?.getElementById(\n    YTB_PLAYER_ID,\n  ) as unknown as YTbPlayer;\n  if (player && typeof player.getAvailableQualityLevels === 'function') {\n    return player;\n  }\n  return null;\n}\n\nfunction updatePlayer() {\n  const newPlayer = getPlayer();\n\n  console.warn('[Ytb Enforcer] Updating player');\n\n  if (!newPlayer) return null;\n\n  if (globalState.playerRef !== newPlayer) {\n    globalState.playerRef = newPlayer;\n    console.warn('[Ytb Enforcer] Player found or replaced');\n\n    globalState.playerRef?.addEventListener?.(\n      'onPlaybackQualityChange',\n      enforceQuality,\n    );\n  }\n\n  return globalState.playerRef;\n}\n\nfunction selectBestQuality(\n  available: YTbQualityLevel[],\n): YTbQualityLevel | null {\n  const qualitiesWithoutAuto = available.filter(\n    (quality) => !quality.startsWith('auto'),\n  );\n\n  const allowedQualities = qualitiesWithoutAuto.filter((quality) => {\n    const index = qualityOrder.indexOf(quality);\n\n    return index !== -1 && index <= qualityOrder.indexOf(DEFAULT_QUALITY);\n  });\n\n  const best = qualityOrder.find((quality) =>\n    allowedQualities.includes(quality),\n  );\n\n  return best ?? null;\n}\n\nfunction getQualityIndex(quality: YTbQualityLevel | null | undefined): number {\n  if (!quality) return -1;\n\n  return qualityOrder.indexOf(quality);\n}\n\nfunction setQuality(quality: YTbQualityLevel) {\n  globalState.chosenQuality = quality;\n  globalState.playerRef?.setPlaybackQuality?.(quality);\n  globalState.playerRef?.setPlaybackQualityRange?.(quality);\n  startEnforcing();\n}\n\nfunction handleQualityFromLocalStorage(\n  qualities: YTbQualityLevel[],\n): YTbQualityLevel | null {\n  try {\n    const rawData = localStorage?.getItem(YTB_LOCAL_STORAGE_QUALITY_KEY);\n\n    if (!rawData) return null;\n\n    const rawDataParsed = JSON.parse(rawData)?.data;\n\n    if (typeof rawDataParsed !== 'string') {\n      return null;\n    }\n\n    const qualityRaw = JSON.parse(rawDataParsed)?.quality;\n    const mappedQuality = chosenQualityMap[qualityRaw] ?? qualityRaw;\n\n    return qualities.includes(mappedQuality) ? mappedQuality : null;\n  } catch (error) {\n    console.warn('Error parsing storage quality data', error);\n    return null;\n  }\n}\n\nfunction handleQualityFromMessage(event: MessageEvent<any>) {\n  if (\n    !event ||\n    event.source !== window ||\n    !event.data ||\n    event.data.source !== YTB_SCRIPT_SOURCE\n  ) {\n    return;\n  }\n\n  const player = updatePlayer();\n\n  if (!player) return;\n\n  if (event.data.type === YTbPlayerActions['set-quality']) {\n    const qualities = player.getAvailableQualityLevels?.() || [];\n    const current = player.getPlaybackQuality();\n\n    const chosen = handleQualityFromLocalStorage(qualities);\n    const chosenIndex = getQualityIndex(chosen);\n\n    const best = selectBestQuality(qualities);\n\n    const desired = chosen && chosenIndex !== -1 ? chosen : best;\n\n    if (desired && (desired !== current || !globalState.enforceIntervalId)) {\n      setQuality(desired);\n    }\n  }\n\n  if (event.data.type === YTbPlayerActions['stop-restrict-quality']) {\n    stopEnforcing();\n    globalState.chosenQuality = null;\n  }\n}\n\nfunction enforceQuality() {\n  try {\n    console.warn('[Ytb Enforcer] Enforcing quality', globalState);\n    const { playerRef, chosenQuality } = globalState;\n\n    if (!playerRef || !chosenQuality) return;\n\n    const current = playerRef.getPlaybackQuality() || DEFAULT_QUALITY;\n    const currentIndex = qualityOrder.indexOf(current);\n\n    if (currentIndex === -1) {\n      playerRef.setPlaybackQuality?.(chosenQuality);\n      playerRef.setPlaybackQualityRange?.(chosenQuality);\n      console.warn(\n        `[Ytb Enforcer] Reverted quality from ${current} to ${chosenQuality}`,\n      );\n    }\n  } catch (error) {\n    console.error('[Ytb Enforcer] Error enforcing quality', error);\n  }\n}\n\nfunction startEnforcing() {\n  if (globalState.enforceIntervalId !== null) return;\n\n  globalState.enforceIntervalId = window?.setInterval(\n    enforceQuality,\n    ENFORCING_QUALITY_CHECK_INTERVAL,\n  );\n  console.warn('[Ytb Enforcer] Started quality enforcement');\n}\n\nfunction stopEnforcing() {\n  const { enforceIntervalId } = globalState;\n\n  if (enforceIntervalId !== null) {\n    clearInterval(enforceIntervalId);\n    globalState.enforceIntervalId = null;\n    console.warn('[Ytb Enforcer] Stopped quality enforcement');\n  }\n}\n\nif (window) {\n  try {\n    window.removeEventListener('message', handleQualityFromMessage);\n    window.addEventListener('message', handleQualityFromMessage);\n  } catch (error) {\n    console.error(\n      '[Ytb Enforcer] Error adding/removing listener to message',\n      error,\n    );\n  }\n}\n"],"names":["DEFAULT_QUALITY","chosenQualityMap","qualityOrder","console","warn","globalState","chosenQuality","enforceIntervalId","playerRef","handleQualityFromMessage","event","source","window","data","player","newPlayer","getPlayer","document","getElementById","getAvailableQualityLevels","addEventListener","enforceQuality","updatePlayer","type","qualities","current","getPlaybackQuality","chosen","localStorage","JSON","rawData","getItem","rawDataParsed","parse","qualityRaw","quality","mappedQuality","includes","error","handleQualityFromLocalStorage","chosenIndex","indexOf","best","available","allowedQualities","filter","startsWith","index","find","selectBestQuality","desired","setPlaybackQuality","setPlaybackQualityRange","setInterval","setQuality","clearInterval","stopEnforcing","removeEventListener"],"sourceRoot":""}